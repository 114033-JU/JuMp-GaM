<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>谿山行旅：登峰 (Travelers Among Mountains)</title>

    <!-- PWA -->
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#2c2c2c">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #2c2c2c;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: "Noto Serif TC", serif;
            color: #333;
        }
        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        canvas {
            background-color: #e6dac3;
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 10px;
            left: 10px;
            pointer-events: none;
        }
        .title {
            font-size: 24px;
            font-weight: bold;
            color: #3b3b3b;
        }
        .subtitle {
            font-size: 14px;
            color: #666;
        }
        #message-box {
            position: absolute;
            top: 40%;
            width: 100%;
            text-align: center;
            display: none;
        }
        .msg-content {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border: 2px solid #000;
            display: inline-block;
        }
        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 12px;
            color: #555;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="600" height="800"></canvas>

    <div id="ui-layer">
        <div class="title">谿山行旅圖</div>
        <div class="subtitle">北宋 范寬 - 尋找藏於樹蔭的真跡</div>
    </div>

    <div id="controls">
        操作：左右方向鍵移動，空白鍵跳躍 | R 鍵重來
    </div>

    <div id="message-box">
        <div class="msg-content" id="msg-text"></div>
    </div>
</div>

<script>
/* ===== 原始遊戲程式碼（未更動） ===== */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const msgBox = document.getElementById('message-box');
const msgText = document.getElementById('msg-text');

let gameState = 'playing';
let frames = 0;
let cameraY = 0;

const player = {
    x: 300, y: 700, w: 20, h: 30,
    vx: 0, vy: 0,
    speed: 5, jumpPower: -12,
    gravity: 0.6, grounded: false
};

const keys = { ArrowLeft:false, ArrowRight:false, Space:false };

window.addEventListener('keydown', e => {
    if(e.code in keys) keys[e.code] = true;
    if(e.code === 'KeyR') resetGame();
});
window.addEventListener('keyup', e => {
    if(e.code in keys) keys[e.code] = false;
});

let platforms = [];
let particles = [];
let secretFound = false;

function initLevel() {
    platforms = [];
    platforms.push({x:0,y:750,w:600,h:50,type:'rock'});
    platforms.push({x:100,y:650,w:100,h:20,type:'rock'});
    platforms.push({x:400,y:600,w:120,h:20,type:'rock'});

    for(let i=0;i<3;i++){
        platforms.push({
            x:50+i*150,y:500-i*80,w:80,h:15,
            type:'donkey',dx:1.5,limit:{min:20,max:500}
        });
    }

    platforms.push({
        x:520,y:680,w:60,h:10,type:'secret_tree',isSecret:true
    });

    let startY=250;
    for(let i=0;i<10;i++){
        platforms.push({
            x:i%2===0?100:350,
            y:startY-i*90,
            w:120,h:20,type:'mountain_ledge'
        });
    }

    platforms.push({
        x:250,y:startY-900,w:100,h:10,type:'temple'
    });
}

function resetGame(){
    Object.assign(player,{x:300,y:700,vx:0,vy:0});
    cameraY=0; gameState='playing'; secretFound=false;
    msgBox.style.display='none';
    initLevel();
}

function update(){
    if(gameState!=='playing') return;

    player.vx = keys.ArrowLeft ? -player.speed :
                keys.ArrowRight ? player.speed :
                player.vx*0.8;

    if(keys.Space && player.grounded){
        player.vy = player.jumpPower;
        player.grounded=false;
    }

    player.vy+=player.gravity;
    player.x+=player.vx;
    player.y+=player.vy;

    player.grounded=false;
    platforms.forEach(p=>{
        if(p.type==='donkey'){
            p.x+=p.dx;
            if(p.x>p.limit.max||p.x<p.limit.min) p.dx*=-1;
        }
        if(player.vy>0 &&
           player.x+player.w>p.x &&
           player.x<p.x+p.w &&
           player.y+player.h>p.y &&
           player.y+player.h<p.y+p.h+20){
            player.y=p.y-player.h;
            player.vy=0;
            player.grounded=true;

            if(p.type==='donkey') player.x+=p.dx;

            if(p.isSecret && !secretFound){
                secretFound=true;
                alert("【發現隱藏要素】\n於樹蔭濃密處發現「范寬」二字款署！");
            }
            if(p.type==='temple'){
                showMessage("【登峰造極】<br>你已抵達山凹蘭若。");
                gameState='won';
            }
        }
    });

    let targetCameraY = Math.max(0, -(player.y-500));
    cameraY += (targetCameraY-cameraY)*0.1;
    frames++;
}

function draw(){
    ctx.fillStyle='#e6dac3';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(0,cameraY);

    platforms.forEach(p=>{
        ctx.fillStyle='#333';
        ctx.fillRect(p.x,p.y,p.w,p.h);
    });

    ctx.fillStyle='#800000';
    ctx.fillRect(player.x,player.y,player.w,player.h);
    ctx.restore();
}

function showMessage(html){
    msgText.innerHTML=html;
    msgBox.style.display='block';
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }

initLevel();
loop();

/* ===== 註冊 Service Worker ===== */
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
}
</script>
</body>
</html>
